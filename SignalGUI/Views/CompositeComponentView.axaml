<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:SignalGUI.ViewModels"
             xmlns:lvc="using:LiveChartsCore.SkiaSharpView.Avalonia"
             xmlns:converters="using:SignalGUI.Converters"
             x:Class="SignalGUI.Views.CompositeComponentView"
             x:DataType="vm:CompositeComponentViewModel">

  <UserControl.Styles>
    <Style Selector="Border.SectionBorder">
      <Setter Property="BorderBrush" Value="Gray" />
      <Setter Property="BorderThickness" Value="1" />
      <Setter Property="Padding" Value="10" />
      <Setter Property="Margin" Value="5" />
    </Style>

    <Style Selector="TextBlock.SectionHeader">
      <Setter Property="FontWeight" Value="Bold" />
      <Setter Property="Margin" Value="0,0,0,5" />
    </Style>
  </UserControl.Styles>

  <UserControl.Resources>
    <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
    <converters:NullToBoolConverter x:Key="NullToBoolConverter" />
  </UserControl.Resources>

  <StackPanel Orientation="Vertical" Margin="10">
    <!-- Saved Signals and Save Buttons -->
    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
      <Button Content="Saved Signals" Command="{Binding ShowSavedSignalsCommand}"
              Margin="0,0,10,0" VerticalAlignment="Center" />
      <Button Content="Save" Command="{Binding SaveGuiInstanceCommand}"
              Margin="0,0,10,0" VerticalAlignment="Center" />
    </StackPanel>

    <!-- Object Name Field with Signal Parameters and Compute Button -->
    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
      <TextBlock Text="Object Name:" VerticalAlignment="Center" Margin="0,0,10,0" />
      <TextBox Text="{Binding ObjectName}" Width="200" />
      <Button Content="Signal Parameters" Command="{Binding SelectSignalParamsCommand}"
              Margin="10,0,0,0" VerticalAlignment="Center" />
      <Button Content="Compute" Command="{Binding ComputeSignalCommand}"
              Margin="10,0,0,0" VerticalAlignment="Center" />
      <Button Content="Cancel" Command="{Binding CancelCommand}"
              Margin="10,0,0,0" VerticalAlignment="Center" />
      <TextBlock Text="{Binding CompletedPercent, StringFormat='Completed: {0}%'}"
                 VerticalAlignment="Center" Margin="10,0,0,0" />
    </StackPanel>

    <!-- Main Container with four columns: Parameters Panel + Source + Expression + Filter -->
    <Border Classes="SectionBorder">
      <Grid ColumnDefinitions="2*, 2*, 2*, 2*">
        <!-- Left Column: Parameter Editing Panel -->
        <StackPanel Grid.Column="0" Margin="0,0,10,0">
          <TextBlock Text="Parameters" Classes="SectionHeader" />
          <ScrollViewer MaxHeight="250">
            <ItemsControl ItemsSource="{Binding CurrentParameters, Mode=OneWay}">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Grid Margin="0,2" ColumnDefinitions="*, 100">
                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold"
                               VerticalAlignment="Center" Grid.Column="0" />
                    <TextBox Text="{Binding StringValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                             Grid.Column="1" Margin="5,0,0,0" />
                  </Grid>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </ScrollViewer>
        </StackPanel>
        <!-- Source Group Column (now Grid.Column="1") -->
        <StackPanel Grid.Column="1" Margin="0,0,5,0">
          <TextBlock Text="Source Group" Classes="SectionHeader" />

          <!-- Dynamic Source List with ScrollViewer -->
          <ScrollViewer MaxHeight="250" Margin="0,0,0,10">
            <ItemsControl ItemsSource="{Binding Sources}">
              <ItemsControl.ItemTemplate>
                <DataTemplate DataType="vm:SourceItemViewModel">
                  <Border Background="Transparent" Margin="0,2" Cursor="Hand">
                    <Border.ContextFlyout>
                      <MenuFlyout>
                        <MenuItem Header="Select" Command="{Binding $parent[UserControl].DataContext.SelectSourceCommand}"
                                  CommandParameter="{Binding .}" />
                      </MenuFlyout>
                    </Border.ContextFlyout>
                    <StackPanel Orientation="Horizontal" PointerPressed="OnSourceItemPointerPressed">
                      <TextBlock Text="{Binding Letter}" FontWeight="Bold" Width="20" VerticalAlignment="Center" />
                      <TextBlock Text=": " VerticalAlignment="Center" />
                      <TextBlock Text="{Binding Configuration}" Background="Transparent" Padding="3" Width="150" VerticalAlignment="Center" />
                      <Button Content="X" Command="{Binding $parent[UserControl].DataContext.RemoveSourceCommand}"
                              CommandParameter="{Binding .}"
                              Width="25" Height="25" Margin="5,0,0,0" VerticalAlignment="Center" />
                    </StackPanel>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </ScrollViewer>

          <!-- Source Dropdown Button -->
          <ComboBox Name="SourceComboBox"
                    ItemsSource="{Binding AvailableSourceTypes}"
                    SelectionChanged="OnSourceSelectionChanged"
                    Margin="0,5,0,0">
            <ComboBox.ItemTemplate>
              <DataTemplate>
                <TextBlock Text="{Binding ObjType.Name}" />
              </DataTemplate>
            </ComboBox.ItemTemplate>
          </ComboBox>
        </StackPanel>

        <!-- Middle Column: Expression Field (now Grid.Column="2") -->
        <StackPanel Grid.Column="2" Margin="5,0">
          <TextBlock Text="Expression" Classes="SectionHeader" />
          <TextBox Text="{Binding Expression}"
                   Watermark="e.g., A+B, A*B/C"
                   Margin="0,0,10,10" />
          <TextBlock Text="Available Sources:" FontWeight="Bold" />
          <ItemsControl ItemsSource="{Binding AvailableSourcesForExpression}">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <WrapPanel />
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Border Background="LightBlue"
                        Padding="5,2"
                        Margin="2"
                        CornerRadius="3">
                  <TextBlock Text="{Binding .}" />
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </StackPanel>

        <!-- Right Column: Filter Group (now Grid.Column="3") -->
        <StackPanel Grid.Column="3" Margin="5,0,0,0">
          <TextBlock Text="Filter Group" Classes="SectionHeader" />

          <!-- Dynamic Filter List with Drag and Drop and ScrollViewer -->
          <ScrollViewer MaxHeight="250" Margin="0,0,0,10">
            <ListBox Name="FilterList" ItemsSource="{Binding Filters}"
                     SelectionMode="Single" BorderThickness="0" Background="Transparent">
              <ListBox.ItemTemplate>
                <DataTemplate DataType="vm:FilterItemViewModel">
                  <Border Background="Transparent" Margin="0,2" DataContext="{Binding .}" Cursor="Hand">
                    <Border.ContextFlyout>
                      <MenuFlyout>
                        <MenuItem Header="Select" Command="{Binding $parent[UserControl].DataContext.SelectFilterCommand}"
                                  CommandParameter="{Binding .}" />
                      </MenuFlyout>
                    </Border.ContextFlyout>
                    <StackPanel Orientation="Horizontal" PointerPressed="OnFilterItemPointerPressed">
                      <Border Width="20" Background="LightGray" CornerRadius="3" Cursor="SizeAll"
                              Name="DragHandle" PointerPressed="OnFilterDragHandlePointerPressed" />
                      <TextBlock Text="{Binding Configuration}" Width="150" Background="Transparent" Padding="3" />
                      <Button Content=""
                              Command="{Binding $parent[UserControl].DataContext.ToggleFilterEnabledCommand}"
                              CommandParameter="{Binding .}"
                              Width="25" Height="25" Margin="5,0,0,0"
                              Background="{Binding Enabled, Converter={StaticResource BoolToColorConverter}}">
                          <Button.Styles>
                              <Style Selector="Button /template/ ContentPresenter">
                                  <Setter Property="CornerRadius" Value="3"/>
                              </Style>
                          </Button.Styles>
                      </Button>
                      <Button Content="X" Command="{Binding $parent[UserControl].DataContext.RemoveFilterCommand}"
                              CommandParameter="{Binding .}"
                              Width="25" Height="25" Margin="5,0,0,0" />
                    </StackPanel>
                  </Border>
                </DataTemplate>
              </ListBox.ItemTemplate>
            </ListBox>
          </ScrollViewer>

          <!-- Filter Dropdown Button -->
          <ComboBox Name="FilterComboBox"
                    ItemsSource="{Binding AvailableFilterTypes}"
                    SelectionChanged="OnFilterSelectionChanged"
                    Margin="0,5,0,0">
            <ComboBox.ItemTemplate>
              <DataTemplate>
                <TextBlock Text="{Binding ObjType.Name}" />
              </DataTemplate>
            </ComboBox.ItemTemplate>
          </ComboBox>
        </StackPanel>
      </Grid>
    </Border>
    
    <!-- Chart Area with Statistics Panel Side by Side -->
    <Grid RowDefinitions="*" Margin="10,10,10,10">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="3*" />
        <ColumnDefinition Width="1*" />
      </Grid.ColumnDefinitions>
      <Border Grid.Column="0" Classes="SectionBorder" Margin="0,0,5,0">
        <StackPanel Orientation="Vertical">
          <TextBlock Text="Signal Plot" Classes="SectionHeader" Margin="0,0,0,5" />
          <Grid RowDefinitions="Auto,*" Margin="0,5,0,0">
            <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,0,0,10">
              <Button Content="Plot Line" Command="{Binding PlotLineCommand}" Margin="0,0,10,0" />
              <Button Content="Plot Scatter" Command="{Binding PlotScatterCommand}" Margin="0,0,10,0" />
              <Button Content="Plot 2D Image" Command="{Binding Plot2DImageCommand}" Margin="0,0,10,0" />
              <Button Content="Clear Plot" Command="{Binding ClearPlotCommand}" />
            </StackPanel>
            <Grid Grid.Row="1" Name="ChartGrid" Height="400">
              <Image Source="{Binding RenderedImage}" IsVisible="{Binding RenderedImage, Converter={StaticResource NullToBoolConverter}, ConverterParameter=true}" />
              <lvc:CartesianChart Series="{Binding Series}"
                                  XAxes="{Binding XAxes}" YAxes="{Binding YAxes}"
                                  IsVisible="{Binding RenderedImage, Converter={StaticResource NullToBoolConverter}, ConverterParameter=false}" />
            </Grid>
          </Grid>
        </StackPanel>
      </Border>

      <!-- Statistics Panel -->
      <Border Grid.Column="1" Classes="SectionBorder" Margin="5,0,0,0"
              IsVisible="{Binding SignalStatistics, Converter={StaticResource NullToBoolConverter}, ConverterParameter=true}">
        <StackPanel Orientation="Vertical">
          <TextBlock Text="Signal Statistics" Classes="SectionHeader" Margin="0,0,0,5" />
          <ScrollViewer>
            <Grid Name="StatisticsGrid" ColumnDefinitions="*, *" Margin="0,5,0,0">
              <ItemsControl Grid.Column="0" ItemsSource="{Binding SignalStatistics}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate x:DataType="vm:SignalStatisticViewModel">
                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold" Margin="0,2" />
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
              <ItemsControl Grid.Column="1" ItemsSource="{Binding SignalStatistics}" Margin="2,0,0,0">
                <ItemsControl.ItemTemplate>
                  <DataTemplate x:DataType="vm:SignalStatisticViewModel">
                    <TextBlock Text="{Binding Stat, StringFormat='{}{0:F3}'}" Margin="0,2" HorizontalAlignment="Right" />
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </Grid>
          </ScrollViewer>
        </StackPanel>
      </Border>
    </Grid>
  </StackPanel>
</UserControl>